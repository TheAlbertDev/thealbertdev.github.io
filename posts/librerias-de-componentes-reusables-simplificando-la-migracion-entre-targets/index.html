<!DOCTYPE html><html lang="es" data-theme="light"> <head><link rel="canonical" href="https://thealbert.dev/posts/librerias-de-componentes-reusables-simplificando-la-migracion-entre-targets/"><meta name="robots" content="index, follow"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@thealbertdev"><meta name="twitter:creator" content="@thealbertdev"><meta name="twitter:description" content="Una mirada a c√≥mo las librer√≠as bien dise√±adas pueden hacer que cambiar de plataforma sea m√°s f√°cil. Separar la l√≥gica de las dependencias espec√≠ficas ayuda a mantener el c√≥digo limpio, reutilizable y preparado para los retos del desarrollo multiplataforma."><meta name="twitter:title" content="Librer√≠as de Componentes Reusables: Simplificando la Migraci√≥n entre Targets"><meta name="twitter:image" content="https://thealbert.dev/_astro/pexels-arturoaez220-18734769.BnFbJMmW_6d3e6.webp"><meta charset="UTF-8"><meta name="description" content="Website personal de Albert √Ålvarez Carulla"><meta name="viewport" content="width=device-width"><link rel="sitemap" href="/sitemap-index.xml"><link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßëüèª‚Äçüíª</text></svg>"><title>theAlbertDev | Librer√≠as de Componentes Reusables: Simplificando la Migraci√≥n entre Targets</title><!-- Google tag (gtag.js) --><script type="text/partytown" async src="https://www.googletagmanager.com/gtag/js?id=G-11JE2P4SZ8"></script><script type="text/partytown">
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-11JE2P4SZ8');
    </script><link rel="stylesheet" href="/_astro/_about_.DQkIPkRx.css">
<style>#post-content[data-astro-cid-g3efgh6g] p[data-astro-cid-g3efgh6g]{margin:24px!important}
</style><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.10.2 - MIT builder.io */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,d,l,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(l=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(v,1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.10.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<l.length;n++)(o=r.createElement("script")).innerHTML=l[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(d)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body class="flex flex-col"> <div class="drawer"> <input id="my-drawer" type="checkbox" class="drawer-toggle"> <div class="drawer-content flex flex-col h-screen supports-[height:100cqh]:h-[100cqh] supports-[height:100svh]:h-[100svh]"> <div class="navbar bg-base-100 w-full fixed top-0 z-10"> <div class="flex-none md:hidden"> <label for="my-drawer" aria-label="open sidebar" class="btn btn-square btn-ghost"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path> </svg> </label> </div> <div class="flex-1"> <a class="btn btn-ghost text-xl" href="/"><div> <span class="font-thin">the</span><span>Albert</span><span class="font-thin">Dev</span> </div></a> </div> <div class="flex-none"> <ul class="menu menu-horizontal px-0 hidden md:flex"> <li> <a href="/posts">Blog</a> </li> <!-- <li>
        <a href={translatePath("/acerca-de", lang)}>{t("nav.about")}</a>
      </li>
      <li>
        <a href={translatePath("/contactar", lang)}>{t("nav.contact")}</a>
      </li> --> </ul> <div class="dropdown dropdown-end"> <div tabindex="0" role="button" class="btn btn-ghost rounded-btn"> <svg width="18" height="18" viewBox="0 0 24 24" data-icon="mdi:language">  <symbol id="ai:mdi:language"><path fill="currentColor" d="m12.87 15.07l-2.54-2.51l.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35C8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5l3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7l1.62-4.33L19.12 17z"/></symbol><use xlink:href="#ai:mdi:language"></use>  </svg> </div> <ul tabindex="0" class="menu dropdown-content bg-base-200 rounded-box z-[2] mt-4 w-52 p-2 shadow"> <li> <a href="/en"> English </a> </li> </ul> </div> <label class="swap swap-rotate btn btn-ghost rounded-btn"> <input id="theme-toggle" type="checkbox" class="theme-controller" value="dark"> <svg width="22" height="22" viewBox="0 0 24 24" class="swap-off" data-icon="tabler:sun">  <symbol id="ai:tabler:sun"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12a4 4 0 1 0 8 0a4 4 0 1 0-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7l-.7.7m0 11.4l.7.7m-12.1-.7l-.7.7"/></symbol><use xlink:href="#ai:tabler:sun"></use>  </svg> <svg width="22" height="22" viewBox="0 0 24 24" class="swap-on" data-icon="tabler:moon">  <symbol id="ai:tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></symbol><use xlink:href="#ai:tabler:moon"></use>  </svg> </label> <script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  window.localStorage.setItem("theme", theme);

  document.getElementById("theme-toggle").checked = theme === "dark";
  document.querySelector("html").setAttribute("data-code-theme", document.getElementById("theme-toggle").checked ? "github-dark-dimmed" : "github-light");
  
  const handleToggleClick = (event) => {
    localStorage.setItem("theme", event.target.checked ? "dark" : "light");
    document.querySelector("html").setAttribute("data-code-theme", event.target.checked ? "github-dark-dimmed" : "github-light");
  };

  document
    .getElementById("theme-toggle")
    .addEventListener("click", handleToggleClick);
</script> </div> </div> <main class="flex-grow container mx-auto p-6 max-w-7xl mt-20">  <article class="container mx-auto max-w-screen-lg" data-astro-cid-g3efgh6g> <header data-astro-cid-g3efgh6g> <div class="my-14" data-astro-cid-g3efgh6g> <div class="text-sm" data-astro-cid-g3efgh6g> <span class="bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent"> Programaci√≥n C </span> </div> <h1 class="text-4xl font-bold mb-4" data-astro-cid-g3efgh6g> Librer√≠as de Componentes Reusables: Simplificando la Migraci√≥n entre Targets </h1> <p data-astro-cid-g3efgh6g>Una mirada a c√≥mo las librer√≠as bien dise√±adas pueden hacer que cambiar de plataforma sea m√°s f√°cil. Separar la l√≥gica de las dependencias espec√≠ficas ayuda a mantener el c√≥digo limpio, reutilizable y preparado para los retos del desarrollo multiplataforma.</p> </div> <img src="/_astro/pexels-arturoaez220-18734769.BnFbJMmW_1F27KI.webp" alt="Librer√≠as de Componentes Reusables: Simplificando la Migraci√≥n entre Targets" class="aspect-[1200/630] mx-0 w-full h-full object-cover rounded-lg overflow-hidden" data-astro-cid-g3efgh6g width="1024" height="683" loading="lazy" decoding="async"> </header> <section class="flex justify-between flex-wrap gap-x-96 pt-6 items-center" data-astro-cid-g3efgh6g> <div class="flex flex-col gap-y-1" data-astro-cid-g3efgh6g> <div class="text-sm flex justify-start items-center font-bold" data-astro-cid-g3efgh6g> <span data-astro-cid-g3efgh6g>Albert</span> </div> <div class="text-sm font-mono" data-astro-cid-g3efgh6g> 7 de diciembre de 2024 | 15 minutos </div> </div> <div class="flex flex-nowrap gap-x-2 items-center"> <span>Compartir:</span> <ul class="menu menu-horizontal -mr-2"> <li> <a target="_blank" href="https://twitter.com/intent/tweet?text=Librer%C3%ADas%20de%20Componentes%20Reusables%3A%20Simplificando%20la%20Migraci%C3%B3n%20entre%20Targets&url=https%3A%2F%2Fthealbert.dev%2Fposts%2Flibrerias-de-componentes-reusables-simplificando-la-migracion-entre-targets%2F"> <svg width="18" height="18" viewBox="0 0 512 512" data-icon="fa6-brands:x-twitter">  <symbol id="ai:fa6-brands:x-twitter"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2L487 464H345L233.7 318.6L106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></symbol><use xlink:href="#ai:fa6-brands:x-twitter"></use>  </svg> </a> </li><li> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fthealbert.dev%2Fposts%2Flibrerias-de-componentes-reusables-simplificando-la-migracion-entre-targets%2F&title=Librer%C3%ADas%20de%20Componentes%20Reusables%3A%20Simplificando%20la%20Migraci%C3%B3n%20entre%20Targets"> <svg width="18" height="18" viewBox="0 0 448 512" data-icon="fa6-brands:linkedin-in">  <symbol id="ai:fa6-brands:linkedin-in"><path fill="currentColor" d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3M447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2c-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3c94 0 111.28 61.9 111.28 142.3V448z"/></symbol><use xlink:href="#ai:fa6-brands:linkedin-in"></use>  </svg> </a> </li><li> <a target="_blank" href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fthealbert.dev%2Fposts%2Flibrerias-de-componentes-reusables-simplificando-la-migracion-entre-targets%2F&p[title]=Librer%C3%ADas%20de%20Componentes%20Reusables%3A%20Simplificando%20la%20Migraci%C3%B3n%20entre%20Targets"> <svg width="18" height="18" viewBox="0 0 512 512" data-icon="fa6-brands:facebook">  <symbol id="ai:fa6-brands:facebook"><path fill="currentColor" d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5c16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1c-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256"/></symbol><use xlink:href="#ai:fa6-brands:facebook"></use>  </svg> </a> </li> </ul> </div> </section> <div class="divider" data-astro-cid-g3efgh6g></div> <div class="grid grid-row-2 md:gap-x-12 grid-cols-1 md:grid-cols-12 lg:grid-cols-10" data-astro-cid-g3efgh6g> <section class="article-content mb-8 prose-pre:max-w-[85vw] md:prose-pre:max-w-none prose prose-p:mb-6 prose-h2:mb-5 prose-h2:mt-10 prose-h3:mb-3 prose-h3:mt-5 col-span-1 md:col-span-8 lg:col-span-7 text-lg" data-astro-cid-g3efgh6g> <p>Operar con componentes externos al propio microcontrolador o target es lo m√°s habitual en el desarrollo de firmware. Por ello, saber c√≥mo desarrollar librer√≠as para ellos es primordial. Esas librer√≠as son las que nos permiten interactuar con ellos y poder intercambiar informaci√≥n u √≥rdenes. Sin embargo, no son pocas las veces en las que me encuentro, en c√≥digo heredado o en c√≥digo de estudiantes (o no tan estudiantes), que esas interacciones con los componentes se hacen directamente en el c√≥digo de la aplicaci√≥n o, a√∫n estando en ficheros aparte, esas interacciones est√°n intr√≠nsecamente ligadas al target.</p>
<p>Veamos un mal ejemplo de desarrollo de librer√≠as para un sensor de temperatura, humedad y presi√≥n BME280 de Bosch en una aplicaci√≥n para un STM32F401RE de STMicroelectronics. En el ejemplo, queremos inicializar el componente y leer la temperatura cada 1 segundo. (En el c√≥digo de ejemplo vamos a obviar todo el ‚Äúruido‚Äù que genera STM32CubeMX/IDE, como la inicializaci√≥n de los diferntes relojes y perif√©ricos, o los comentarios tipo <code>USER CODE BEGIN</code> o <code>USER CODE END</code>.)</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.5ullo.css"><script type="module" src="/_astro/ec.8zarh.js"></script><figure class="frame has-title"><figcaption class="header"><span class="title">main.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">"i2c.h"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">&#x3C;stdint.h></span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">int</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">main</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E">  idx           </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E">  </span><span style="--0:#F69D50;--1:#AE4B07">tx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">64</span><span style="--0:#ADBAC7;--1:#24292E">] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E">  </span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">64</span><span style="--0:#ADBAC7;--1:#24292E">] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp1     </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">  dig_temp2     </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">  dig_temp3     </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span class="indent">  </span><span style="--0:#DCBDFB;--1:#6F42C1">MX_I2C1_Init</span><span style="--0:#ADBAC7;--1:#24292E">();</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code"><span class="indent">  </span><span style="--0:#F69D50;--1:#AE4B07">tx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[idx</span><span style="--0:#F5776E;--1:#BF3441">++</span><span style="--0:#ADBAC7;--1:#24292E">] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">0b</span><span style="--0:#6CB6FF;--1:#005CC5">10100011</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code"><span class="indent">  </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Write</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">77</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">F4</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                    </span></span><span style="--0:#ADBAC7;--1:#24292E">tx_buffer, </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#6CB6FF;--1:#005CC5">200</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code"><span class="indent">  </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Read</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">77</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">88</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                   </span></span><span style="--0:#ADBAC7;--1:#24292E">rx_buffer, </span><span style="--0:#6CB6FF;--1:#005CC5">6</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#6CB6FF;--1:#005CC5">200</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">22</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">23</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">24</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">              </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">25</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">26</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> (</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)(((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">2</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">27</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                        </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">3</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">));</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">28</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">29</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> (</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)(((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">30</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                        </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">5</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">));</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">31</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">32</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">while</span><span style="--0:#ADBAC7;--1:#24292E"> (</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">33</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">34</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">   temperature </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">35</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E"> adc_temp    </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">36</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E"> t_fine      </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">37</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">   var1        </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">38</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">   var2        </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">39</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code"><span class="indent">      </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Read</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">77</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">FA</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                       </span></span><span style="--0:#ADBAC7;--1:#24292E">rx_buffer, </span><span style="--0:#6CB6FF;--1:#005CC5">3</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#6CB6FF;--1:#005CC5">200</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">42</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">43</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">adc_temp </span><span style="--0:#F5776E;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">44</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">          </span></span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E">)((((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">12</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">45</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                    </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">46</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                    </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">2</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">>></span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">));</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">47</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">48</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">var1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">16384.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">49</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">              </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1024.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">50</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">             </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp2);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">51</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">var2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">131072.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">52</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">               </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8192.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">53</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">              </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">131072.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">54</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">               </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8192.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">)) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">55</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">             </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp3);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">56</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">57</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">t_fine </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> (</span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E">)(var1 </span><span style="--0:#F5776E;--1:#BF3441">+</span><span style="--0:#ADBAC7;--1:#24292E"> var2);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">58</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">59</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">temperature </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)t_fine) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">5129.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">60</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">61</div></div><div class="code"><span class="indent">      </span><span style="--0:#949EA8;--1:#616972">// Temperature available for the application.</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">62</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">63</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include &#x22;i2c.h&#x22;#include <stdint.h>int main(void){  uint8_t  idx           = 0U;  uint8_t  tx_buffer[64] = {0};  uint8_t  rx_buffer[64] = {0};  uint16_t dig_temp1     = 0U;  int16_t  dig_temp2     = 0;  int16_t  dig_temp3     = 0;  MX_I2C1_Init();  tx_buffer[idx++] = 0b10100011;  HAL_I2C_Mem_Write(&#x26;hi2c1, 0x77U << 1U, 0xF4U, 1U,                    tx_buffer, 1U, 200U);  HAL_I2C_Mem_Read(&#x26;hi2c1, 0x77U << 1U, 0x88U, 1U,                   rx_buffer, 6U, 200U);  dig_temp1 = ((uint16_t)rx_buffer[0]) |              (((uint16_t)rx_buffer[1]) << 8U);  dig_temp2 = (int16_t)(((uint16_t)rx_buffer[2]) |                        (((uint16_t)rx_buffer[3]) << 8U));  dig_temp3 = (int16_t)(((uint16_t)rx_buffer[4]) |                        (((uint16_t)rx_buffer[5]) << 8U));  while (1)  {      float   temperature = 0.0f;      int32_t adc_temp    = 0;      int32_t t_fine      = 0;      float   var1        = 0.0f;      float   var2        = 0.0f;      HAL_I2C_Mem_Read(&#x26;hi2c1, 0x77U << 1U, 0xFAU, 1U,                       rx_buffer, 3U, 200U);      adc_temp =          (int32_t)((((uint32_t)rx_buffer[0]) << 12U) |                    (((uint32_t)rx_buffer[1]) << 4U) |                    (((uint32_t)rx_buffer[2]) >> 4U));      var1 = (((float)adc_temp) / 16384.0f -              ((float)dig_temp1) / 1024.0f) *             ((float)dig_temp2);      var2 = ((((float)adc_temp) / 131072.0f -               ((float)dig_temp1) / 8192.0f) *              (((float)adc_temp) / 131072.0f -               ((float)dig_temp1) / 8192.0f)) *             ((float)dig_temp3);      t_fine = (int32_t)(var1 + var2);      temperature = ((float)t_fine) / 5129.0f;      // Temperature available for the application.  }}"><div></div></button></div></figure></div>
<p>Bas√°ndonos en este ejemplo, podemos plantearnos una serie de cuestiones: ¬øqu√© ocurre si necesito cambiar de target (ya sea por falta de stock, querer reducir costes, o por simplemente trabajar en otro producto que hace uso del mismo componente)?, ¬øqu√© ocurre si tengo m√°s de un componente del mismo tipo en el sistema?, ¬øqu√© ocurre si en otro producto tengo el mismo componente?, ¬øcomo puedo testear mi desarrollo si a√∫n no dispongo del hardware (situaci√≥n muy com√∫n en el mundo profesional en el que las fases de desarrollo de firmware y hardware se suelen solapar en algunos instantes del proceso)?</p>
<p>En las tres primeras cuestiones la respuesta es editar el c√≥digo, ya sea por tener que cambiarlo completamente al cambiar de target, por tener que duplicar el c√≥digo ya existente para poder operar con un componente adicional del mismo tipo, o por tener que implementar el mismo c√≥digo para el otro proyecto/producto. En la √∫ltima cuesti√≥n, no hay manera de poder testear el c√≥digo sin disponer del hardware que permita ejecutar el c√≥digo. Esto implica que solo despu√©s de haberse finalizado el hardware podr√≠amos empezar a testear nuestro c√≥digo y empezar a solucionar errores inherentes al propio desarrollo de firmware, alargando el tiempo de desarrollo del producto. Esto nos plantea la pregunta que d√° origen a este post: ¬øes posible desarrollar librer√≠as para componentes que sean independientes del target y nos permitan su reuso? La respuesta es s√≠ y es lo que veremos en este post.</p>
<section class="heading" data-heading-rank="2"><h2 id="aislando-la-librer√≠a-del-target">Aislando la librer√≠a del target</h2>
<p>Para poder aislar las librer√≠as de un target seguiremos dos reglas: 1) implementaremos la librer√≠a en su propia unidad de compilaci√≥n, es decir, en su propio archivo, y 2) no habr√° niguna referencia a ning√∫na header o funci√≥n propia del target. Haremos un ejemplo implementando una librer√≠a sencilla para el BME280. Para empezar, crearemos dentro de nuestro proyecto una carpeta llamada <code>bme280</code>. Dentro de la carpeta <code>bme280</code> creamos los ficheros: <code>bme280.c</code>, <code>bme280.h</code>, y <code>bme280_interface.h</code>. Os aclaro ya la duda: no, no se me ha olvidado nombrar el fichero <code>bme280_interface.c</code>. Este archivo no formar√° parte de la librer√≠a.</p>
<div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">Yo suelo poner las carpetas de las librer√≠as dentro de <code>Application/lib/</code>.</div></div>
<p>El archivo <code>bme280.h</code> declarar√° todas las funciones disponibles en nuestra librer√≠a para ser llamadas por nuestra aplicaci√≥n. Por otro lado, el archivo <code>bme280.c</code> implementar√° la definici√≥n de esas funciones y otras auxiliares y privadas que pueda contener la librer√≠a. ¬øY qu√© continene el archivo <code>bme280_interface.h</code>? Pues bien, nuestro target, sea cual sea, necesitar√° comunicarse con el componente BME280 de un modo u otro. En este caso, el BME280 permite comunicaci√≥n SPI o I2C. En ambos casos, el target debe de poder escribir y leer bytes del componente. El archivo <code>bme280_interface.h</code> declarar√° esas funciones para poder ser llamadas desde la librer√≠a. La definici√≥n de esas funciones ser√° lo √∫nico que estar√° atado al target en cuesti√≥n y ser√° lo √∫nico que debamos de editar en caso de migrar la librer√≠a a otro target.</p>
</section><section class="heading" data-heading-rank="2"><h2 id="declaraci√≥n-de-la-api-de-la-librer√≠a">Declaraci√≥n de la API de la librer√≠a</h2>
<p>Empezamos declarando las funciones disponibles en la librer√≠a en el archivo <code>bme280.h</code>.</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.h</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#ifndef</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_H_</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_H_</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">  </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_get_temperature</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#endif</span><span style="--0:#949EA8;--1:#616972"> // BME280_H_</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#ifndef BME280_H_#define BME280_H_void  BME280_init(void);float BME280_get_temperature(void);#endif // BME280_H_"><div></div></button></div></figure></div>
<p>La liber√≠a que estamos haciendo ser√° muy simple y solo implementaremos una funci√≥n de inicialiciaci√≥n sencilla y otra para obtener una medida de temperatura. Ahora vamos a implementar las funciones en el archivo <code>bme280.c</code>.</p>
<div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">Para no hacer el post muy <i>verbose</i>, me estoy ahorrando los comentarios que documentar√≠an las funciones.</div></div><div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">En este fichero .h es donde ir√≠an esos comentarios.</div></div><div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">Teniendo disponibles hoy en d√≠as tantas herramientas IA, no hay excusa para no documentar tu c√≥digo.</div></div>
</section><section class="heading" data-heading-rank="2"><h2 id="implementaci√≥n-de-la-api-del-driver">Implementaci√≥n de la API del driver</h2>
<p>El esqueleto del archivo <code>bme280.c</code> ser√≠a el siguiente:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_get_temperature</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="void BME280_init(void){}float BME280_get_temperature(void){}"><div></div></button></div></figure></div>
<p>Vamos a centrarnos en la inicializaci√≥n. Como hemos comentado antes, el BME280 permite comunicaci√≥n I2C y SPI. En ambos casos, debemos de inicializar el perif√©rico pertinente del target (I2C o SPI) y posteriormente debemos de poder enviar y recibir bytes a trav√©s de ellos. Suponiendo que usamos comunicaci√≥n I2C, en el STM32F401RE ser√≠a:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span class="indent">  </span><span style="--0:#DCBDFB;--1:#6F42C1">MX_I2C1_Init</span><span style="--0:#ADBAC7;--1:#24292E">();</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="void BME280_init(void){  MX_I2C1_Init();}"><div></div></button></div></figure></div>
<p>Una vez inicializado el perif√©rico, debemos de inicializar el componente. Ah√≠ deberemos de hacer uso de la informaci√≥n provista por el fabricante en su <a href="https://www.bosch-sensortec.com/products/environmental-sensors/humidity-sensors-bme280/" target="_blank">datasheet</a>. Ya os hago yo un resumen: se debe de iniciar el canal de muestreo de la temperatura (que est√° en sleep por defecto) y leer unas constantes de calibraci√≥n del componente guardadas en su ROM y que necesitaremos m√°s adelante para poder calcular la temperatura.</p>
<div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">El objetivo del post no es aprender a usar el BME280, por lo que me saltar√© detalles de su uso que pod√©is ver en su datasheet.</div></div>
<p>La inicializaci√≥n quedar√≠a del siguiente modo:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">"i2c.h"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">&#x3C;stdint.h></span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_TX_BUFFER_SIZE</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">32</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_RX_BUFFER_SIZE</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">32</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_TIMEOUT</span><span style="--0:#ADBAC7;--1:#24292E">        </span><span style="--0:#6CB6FF;--1:#005CC5">200</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_ADDRESS</span><span style="--0:#ADBAC7;--1:#24292E">        </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">77</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_REG_CTRL_MEAS</span><span style="--0:#ADBAC7;--1:#24292E">  </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">F4</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_REG_DIG_T</span><span style="--0:#ADBAC7;--1:#24292E">      </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">88</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">static</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">static</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">  dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">static</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">  dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> idx                              </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">tx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[BME280_TX_BUFFER_SIZE] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[BME280_RX_BUFFER_SIZE] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">HAL_StatusTypeDef status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_ERROR;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">22</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">23</div></div><div class="code"><span class="indent">  </span><span style="--0:#DCBDFB;--1:#6F42C1">MX_I2C1_Init</span><span style="--0:#ADBAC7;--1:#24292E">();</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">24</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">25</div></div><div class="code"><span class="indent">  </span><span style="--0:#F69D50;--1:#AE4B07">tx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[idx</span><span style="--0:#F5776E;--1:#BF3441">++</span><span style="--0:#ADBAC7;--1:#24292E">] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">0b</span><span style="--0:#6CB6FF;--1:#005CC5">10100011</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">26</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">27</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Write</span><span style="--0:#ADBAC7;--1:#24292E">(</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">28</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, BME280_ADDRESS </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, BME280_REG_CTRL_MEAS,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">29</div></div><div class="code"><span class="indent">      </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, tx_buffer, (</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)idx, BME280_TIMEOUT);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">30</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">31</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_OK)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">32</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">33</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">34</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Read</span><span style="--0:#ADBAC7;--1:#24292E">(</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">35</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, BME280_ADDRESS </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, BME280_REG_DIG_T, </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">36</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">rx_buffer, </span><span style="--0:#6CB6FF;--1:#005CC5">6</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, BME280_TIMEOUT);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">37</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">38</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_OK)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">39</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">42</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">43</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">44</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">45</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">2</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">46</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">3</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">47</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">48</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">49</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">5</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">50</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">51</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">52</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include &#x22;i2c.h&#x22;#include <stdint.h>#define BME280_TX_BUFFER_SIZE 32U#define BME280_RX_BUFFER_SIZE 32U#define BME280_TIMEOUT        200U#define BME280_ADDRESS        0x77U#define BME280_REG_CTRL_MEAS  0xF4U#define BME280_REG_DIG_T      0x88Ustatic uint16_t dig_temp1 = 0U;static int16_t  dig_temp2 = 0;static int16_t  dig_temp3 = 0;void BME280_init(void){  uint8_t idx                              = 0U;  uint8_t tx_buffer[BME280_TX_BUFFER_SIZE] = {0};  uint8_t rx_buffer[BME280_RX_BUFFER_SIZE] = {0};  HAL_StatusTypeDef status = HAL_ERROR;  MX_I2C1_Init();  tx_buffer[idx++] = 0b10100011;  status = HAL_I2C_Mem_Write(      &#x26;hi2c1, BME280_ADDRESS << 1U, BME280_REG_CTRL_MEAS,      1U, tx_buffer, (uint16_t)idx, BME280_TIMEOUT);  if (status != HAL_OK)      return;  status = HAL_I2C_Mem_Read(      &#x26;hi2c1, BME280_ADDRESS << 1U, BME280_REG_DIG_T, 1U,      rx_buffer, 6U, BME280_TIMEOUT);  if (status != HAL_OK)      return;  dig_temp1 = ((uint16_t)rx_buffer[0]);  dig_temp1 =      dig_temp1 | (((uint16_t)rx_buffer[1]) << 8U);  dig_temp2 = ((int16_t)rx_buffer[2]);  dig_temp2 = dig_temp2 | (((int16_t)rx_buffer[3]) << 8U);  dig_temp3 = ((int16_t)rx_buffer[4]);  dig_temp3 = dig_temp3 | (((int16_t)rx_buffer[5]) << 8U);  return;}"><div></div></button></div></figure></div>
<p>Detallitos a comentar. El valor de calibraci√≥n que leemos lo guardamos en unas variables llamadas <code>dig_temp1</code>, <code>dig_temp2</code> y <code>dig_temp3</code>. Esas variables est√°n declaradas como globales para que est√©n luego disponibles para el resto de funciones de la librer√≠a. Sin embargo, est√°n declaradas como est√°ticas para que solo est√©n accesibles dentro de la librer√≠a. Nadie fuera de la librer√≠a necesita tener acceso a esos valores ni debe de poder modificarlos.</p>
<p>Tambi√©n vemos que se comprueba el valor devuelto por las instrucciones de I2C y en el caso de alg√∫n fallo detenemos la ejecuci√≥n de la funci√≥n. No est√° mal, pero es mejorable. ¬øNo estar√≠a mejor notificar al que ha llamado a la funci√≥n <code>BME280_init</code> que algo no ha ido bien si ha sido el caso? Para ello, en el archivo <code>bme280.h</code> definimos el siguiente <code>enum</code>.</p>
<div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">Yo los hago utilizando <code>typedef</code>.</div></div><div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">Hay debate sobre el uso de los <code>typedef</code> ya que permiten mejorar la legibilidad del c√≥digo a costa de ocultar detalles.</div></div><div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">Es cuesti√≥n de gustos y de estar todos los miembros del equipo de desarrollo en la misma p√°gina.</div></div>
<br/>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.h</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">typedef</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">enum</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">BME280_Status_Ok,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">BME280_Status_Status_Err,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">} </span><span style="--0:#6CB6FF;--1:#005CC5">BME280_Status_t</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="typedef enum{  BME280_Status_Ok,  BME280_Status_Status_Err,} BME280_Status_t;"><div></div></button></div></figure></div>
<p>Dos apuntes: suelo a√±adir el sufijo <code>_t</code> a los typedefs para indicar que son un typedef, y los valores o miembros del typedef les a√±ado el prefijo del propio typedef, en este caso <code>BME280_Status_</code>. Esto √∫ltimo es para evitar la colisi√≥n entre enums de diferentes librer√≠as. Si todo el mundo usara como enum <code>OK</code>, estar√≠amos en problemas.</p>
<p>Ya podemos modificar tanto la declariaci√≥n (<code>bme280.h</code>) como la definici√≥n (<code>bme280.c</code>) de la funci√≥n <code>BME280_init</code> para devolver un status. La versi√≥n final de nuestra funci√≥n ser√≠a:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.h</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="BME280_Status_t BME280_init(void);"><div></div></button></div></figure></div>
<br/>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">"bme280.h"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> idx                              </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">tx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[BME280_TX_BUFFER_SIZE] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[BME280_RX_BUFFER_SIZE] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">HAL_StatusTypeDef status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_ERROR;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code"><span class="indent">  </span><span style="--0:#DCBDFB;--1:#6F42C1">MX_I2C1_Init</span><span style="--0:#ADBAC7;--1:#24292E">();</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span class="indent">  </span><span style="--0:#F69D50;--1:#AE4B07">tx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[idx</span><span style="--0:#F5776E;--1:#BF3441">++</span><span style="--0:#ADBAC7;--1:#24292E">] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">0b</span><span style="--0:#6CB6FF;--1:#005CC5">10100011</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Write</span><span style="--0:#ADBAC7;--1:#24292E">(</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, BME280_ADDRESS </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, BME280_REG_CTRL_MEAS,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code"><span class="indent">      </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, tx_buffer, (</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)idx, BME280_TIMEOUT);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_OK)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">22</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Read</span><span style="--0:#ADBAC7;--1:#24292E">(</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">23</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, BME280_ADDRESS </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, BME280_REG_DIG_T, </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">24</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">rx_buffer, </span><span style="--0:#6CB6FF;--1:#005CC5">6</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, BME280_TIMEOUT);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">25</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">26</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_OK)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">27</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">28</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">29</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">30</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">31</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">32</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">33</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">2</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">34</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">3</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">35</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">36</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">37</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">5</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">38</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">39</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME_Status_Ok;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include &#x22;bme280.h&#x22;BME280_Status_t BME280_init(void){  uint8_t idx                              = 0U;  uint8_t tx_buffer[BME280_TX_BUFFER_SIZE] = {0};  uint8_t rx_buffer[BME280_RX_BUFFER_SIZE] = {0};  HAL_StatusTypeDef status = HAL_ERROR;  MX_I2C1_Init();  tx_buffer[idx++] = 0b10100011;  status = HAL_I2C_Mem_Write(      &#x26;hi2c1, BME280_ADDRESS << 1U, BME280_REG_CTRL_MEAS,      1U, tx_buffer, (uint16_t)idx, BME280_TIMEOUT);  if (status != HAL_OK)      return BME280_Status_Err;  status = HAL_I2C_Mem_Read(      &#x26;hi2c1, BME280_ADDRESS << 1U, BME280_REG_DIG_T, 1U,      rx_buffer, 6U, BME280_TIMEOUT);  if (status != HAL_OK)      return BME280_Status_Err;  dig_temp1 = ((uint16_t)rx_buffer[0]);  dig_temp1 =      dig_temp1 | (((uint16_t)rx_buffer[1]) << 8U);  dig_temp2 = ((int16_t)rx_buffer[2]);  dig_temp2 = dig_temp2 | (((int16_t)rx_buffer[3]) << 8U);  dig_temp3 = ((int16_t)rx_buffer[4]);  dig_temp3 = dig_temp3 | (((int16_t)rx_buffer[5]) << 8U);  return BME_Status_Ok;}"><div></div></button></div></figure></div>
<p>Puesto que utilizamos el enum de status, debemos de incluir el fichero <code>bme280.h</code> en el archivo <code>bme280.c</code>. Ya hemos inicializado la librer√≠a. Ahora vamos a hacer la funci√≥n para obtener la temperatura. Tendr√≠a el siguiente aspecto:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_REG_TEMP</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">FA</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_get_temperature</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#F69D50;--1:#AE4B07">temperature</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[BME280_RX_BUFFER_SIZE] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E"> adc_temp                         </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E"> t_fine                           </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">   var1                             </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">   var2                             </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">HAL_StatusTypeDef status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_ERROR;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#ADBAC7;--1:#24292E">temperature </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Read</span><span style="--0:#ADBAC7;--1:#24292E">(</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, BME280_ADDRESS </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, BME280_REG_TEMP, </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">rx_buffer, </span><span style="--0:#6CB6FF;--1:#005CC5">3</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, BME280_TIMEOUT);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_OK)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">22</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">adc_temp </span><span style="--0:#F5776E;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">23</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">        </span></span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E">)((((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">12</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">24</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                  </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">25</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                  </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">2</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">>></span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">));</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">26</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">27</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">var1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">16384.0</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">28</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">          </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1024.0</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">29</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">         </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp2);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">30</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">var2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">131072.0</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">31</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">           </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8192.0</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">32</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">          </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">131072.0</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">33</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">           </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8192.0</span><span style="--0:#ADBAC7;--1:#24292E">)) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">34</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">         </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp3);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">35</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">36</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">t_fine </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> (</span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E">)(var1 </span><span style="--0:#F5776E;--1:#BF3441">+</span><span style="--0:#ADBAC7;--1:#24292E"> var2);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">37</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">38</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#ADBAC7;--1:#24292E">temperature </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)t_fine) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">5129.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">39</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Ok;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#define BME280_REG_TEMP 0xFAUBME280_Status_t BME280_get_temperature(float *temperature){  uint8_t rx_buffer[BME280_RX_BUFFER_SIZE] = {0};  int32_t adc_temp                         = 0;  int32_t t_fine                           = 0;  float   var1                             = 0.0f;  float   var2                             = 0.0f;  HAL_StatusTypeDef status = HAL_ERROR;  *temperature = 0.0f;  status = HAL_I2C_Mem_Read(      &#x26;hi2c1, BME280_ADDRESS << 1U, BME280_REG_TEMP, 1U,      rx_buffer, 3U, BME280_TIMEOUT);  if (status != HAL_OK)      return BME280_Status_Err;  adc_temp =        (int32_t)((((uint32_t)rx_buffer[0]) << 12U) |                  (((uint32_t)rx_buffer[1]) << 4U) |                  (((uint32_t)rx_buffer[2]) >> 4U));  var1 = (((float)adc_temp) / 16384.0 -          ((float)dig_temp1) / 1024.0) *         ((float)dig_temp2);  var2 = ((((float)adc_temp) / 131072.0 -           ((float)dig_temp1) / 8192.0) *          (((float)adc_temp) / 131072.0 -           ((float)dig_temp1) / 8192.0)) *         ((float)dig_temp3);  t_fine = (int32_t)(var1 + var2);  *temperature = ((float)t_fine) / 5129.0f;  return BME280_Status_Ok;}"><div></div></button></div></figure></div>
<p>Te has dado cuenta, eh. Hemos modificado la firma de la funci√≥n para que devuelva un status para saber si ha habido problemas de comunicaci√≥n con el componente o no, y el resultado lo devolvemos a trav√©s del puntero pasado como par√°metro a la funci√≥n. Si est√°s siguiendo el ejemplo, recuerda de modificar la declaraci√≥n de la funci√≥n en el archivo <code>bme280.h</code> para que sean iguales.</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.h</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_get_temperature</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#F69D50;--1:#AE4B07">temperature</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="BME280_Status_t BME280_get_temperature(float *temperature);"><div></div></button></div></figure></div>
<p>¬°Genial! Llegados a este punto, en la aplicaci√≥n podemos tener:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">main.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">"bme280.h"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">int</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">main</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span class="indent">  </span><span style="--0:#6CB6FF;--1:#005CC5">BME280_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_init</span><span style="--0:#ADBAC7;--1:#24292E">();</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Ok)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span class="indent">      </span><span style="--0:#DCBDFB;--1:#6F42C1">Error_Handler</span><span style="--0:#ADBAC7;--1:#24292E">();</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">while</span><span style="--0:#ADBAC7;--1:#24292E"> (</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E"> temperature </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_get_temperature</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">temperature);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Ok)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code"><span class="indent">          </span><span style="--0:#DCBDFB;--1:#6F42C1">Error_Handler</span><span style="--0:#ADBAC7;--1:#24292E">();</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span class="indent">      </span><span style="--0:#949EA8;--1:#616972">// Temperature available for the application.</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include &#x22;bme280.h&#x22;int main(void){  BME280_Status_t status = BME280_Status_Err;  status = BME280_init();  if (status != BME280_Status_Ok)      Error_Handler();  while (1)  {      float temperature = 0.0f;      status = BME280_get_temperature(&#x26;temperature);      if (status != BME280_Status_Ok)          Error_Handler();      // Temperature available for the application.  }}"><div></div></button></div></figure></div>
<p>¬°Superlimpio! Esto s√≠ es legible. Ignorad el uso de la funci√≥n <code>Error_Handler</code> de STM32CubeMX/IDE. No suele ser recomendado hacer uso de ella, pero para el ejemplo nos sirve. Pues ya estar√≠a, ¬øno?</p>
<p>¬°Pues no! Hemos encapsulado nuestras interacciones con el componente en sus propios ficheros. ¬°Pero su c√≥digo a√∫n sigue llamando funciones del target (las funciones HAL)! ¬°Si cambiamos de target deberemos de reescribir la librer√≠a! Pista: a√∫n no hemos escrito nada en el archivo <code>bme280_interface.h</code>. Vamos con ello.</p>
</section><section class="heading" data-heading-rank="2"><h2 id="declaraci√≥n-de-la-interfaz">Declaraci√≥n de la interfaz</h2>
<p>Si nos fijamos en el archivo <code>bme280.c</code>, nuestras interacciones con el target son tres: para inicializar perif√©ricos, para escribir/enviar bytes, y para leer/recibir bytes. Entonces, lo que vamos a hacer es en el archivo <code>bme280_interface.h</code> declarar esas tres interacciones.</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280_interface.h</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#ifndef</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_INTERFACE_H_</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_INTERFACE_H_</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">&#x3C;stdint.h></span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">typedef</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">enum</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">BME280_Interface_Ok,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">BME280_Interface_Err,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">} </span><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">address</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">timeout</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code"><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_write</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">reg</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#F69D50;--1:#AE4B07">data</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span class="indent">                     </span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">size</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code"><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_read</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">reg</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#F69D50;--1:#AE4B07">data</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span class="indent">                    </span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">size</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#endif</span><span style="--0:#949EA8;--1:#616972"> // BME280*INTERFACE_H_</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#ifndef BME280_INTERFACE_H_#define BME280_INTERFACE_H_#include <stdint.h>typedef enum{  BME280_Interface_Ok,  BME280_Interface_Err,} BME280_Interface_Status_t;BME280_Interface_Status_tBME280_Interface_init(uint8_t address, uint32_t timeout);BME280_Interface_Status_tBME280_Interface_write(uint8_t reg, uint8_t *data,                     uint16_t size);BME280_Interface_Status_tBME280_Interface_read(uint8_t reg, uint8_t *data,                    uint16_t size);#endif // BME280*INTERFACE_H_"><div></div></button></div></figure></div>
<p>Si te fijas, tambi√©n hemos definido un nuevo tipo para los status de la interfaz. Ahora, en lugar de llamar las funciones del target, llamaremos estas funciones desde el archivo <code>bme280.c</code>.</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">"bme280.h"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">"bme280_interface.h"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_TX_BUFFER_SIZE</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">32</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_RX_BUFFER_SIZE</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">32</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_TIMEOUT</span><span style="--0:#ADBAC7;--1:#24292E">        </span><span style="--0:#6CB6FF;--1:#005CC5">200</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_ADDRESS</span><span style="--0:#ADBAC7;--1:#24292E">        </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">77</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_REG_CTRL_MEAS</span><span style="--0:#ADBAC7;--1:#24292E">  </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">F4</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_REG_DIG_T</span><span style="--0:#ADBAC7;--1:#24292E">      </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">88</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#define</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_REG_TEMP</span><span style="--0:#ADBAC7;--1:#24292E">       </span><span style="--0:#F5776E;--1:#BF3441">0x</span><span style="--0:#6CB6FF;--1:#005CC5">FA</span><span style="--0:#F5776E;--1:#BF3441">U</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">static</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">static</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">  dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">static</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">  dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">void</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> idx                              </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">tx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[BME280_TX_BUFFER_SIZE] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[BME280_RX_BUFFER_SIZE] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">22</div></div><div class="code"><span class="indent">  </span><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">23</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">24</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_init</span><span style="--0:#ADBAC7;--1:#24292E">(BME280_ADDRESS,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">25</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                                 </span></span><span style="--0:#ADBAC7;--1:#24292E">BME280_TIMEOUT);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">26</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">27</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Ok)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">28</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">29</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">30</div></div><div class="code"><span class="indent">  </span><span style="--0:#F69D50;--1:#AE4B07">tx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[idx</span><span style="--0:#F5776E;--1:#BF3441">++</span><span style="--0:#ADBAC7;--1:#24292E">] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">0b</span><span style="--0:#6CB6FF;--1:#005CC5">10100011</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">31</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">32</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_write</span><span style="--0:#ADBAC7;--1:#24292E">(</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">33</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">BME280_REG_CTRL_MEAS, tx_buffer, (</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)idx);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">34</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">35</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Ok)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">36</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">37</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">38</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_read</span><span style="--0:#ADBAC7;--1:#24292E">(BME280_REG_DIG_T,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">39</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                                 </span></span><span style="--0:#ADBAC7;--1:#24292E">rx_buffer, </span><span style="--0:#6CB6FF;--1:#005CC5">6</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Ok)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">42</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">43</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">44</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">45</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">46</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp1 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">47</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">48</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">2</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">49</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp2 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">3</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">50</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">51</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#ADBAC7;--1:#24292E">]);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">52</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> dig_temp3 </span><span style="--0:#F5776E;--1:#BF3441">|</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">int16_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">5</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">53</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">54</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Ok;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">55</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">56</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">57</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_get_temperature</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#F69D50;--1:#AE4B07">temperature</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">58</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">59</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[BME280_RX_BUFFER_SIZE] </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> {</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">60</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E"> adc_temp                         </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">61</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E"> t_fine                           </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">62</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">  var1                             </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">63</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">  var2                             </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">64</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">65</div></div><div class="code"><span class="indent">  </span><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span><span style="--0:#ADBAC7;--1:#24292E"> status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">66</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">67</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#ADBAC7;--1:#24292E">temperature </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">68</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">69</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_read</span><span style="--0:#ADBAC7;--1:#24292E">(BME280_REG_TEMP,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">70</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                                 </span></span><span style="--0:#ADBAC7;--1:#24292E">rx_buffer, </span><span style="--0:#6CB6FF;--1:#005CC5">3</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">71</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">72</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Ok)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">73</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">74</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">75</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">adc_temp </span><span style="--0:#F5776E;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">76</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">      </span></span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E">)((((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">12</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">77</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">|</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">78</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">                </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E">)</span><span style="--0:#F69D50;--1:#AE4B07">rx_buffer</span><span style="--0:#ADBAC7;--1:#24292E">[</span><span style="--0:#6CB6FF;--1:#005CC5">2</span><span style="--0:#ADBAC7;--1:#24292E">]) </span><span style="--0:#F5776E;--1:#BF3441">>></span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">4</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">));</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">79</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">80</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">var1 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> (((</span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">16384.0</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">81</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">          </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1024.0</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">82</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">         </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp2);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">83</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">var2 </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((((</span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">131072.0</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">84</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">           </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8192.0</span><span style="--0:#ADBAC7;--1:#24292E">) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">85</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">          </span></span><span style="--0:#ADBAC7;--1:#24292E">(((</span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">)adc_temp) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">131072.0</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">86</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">           </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp1) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">8192.0</span><span style="--0:#ADBAC7;--1:#24292E">)) </span><span style="--0:#F5776E;--1:#BF3441">*</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">87</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">         </span></span><span style="--0:#ADBAC7;--1:#24292E">((</span><span style="--0:#F5776E;--1:#BF3441">double</span><span style="--0:#ADBAC7;--1:#24292E">)dig_temp3);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">88</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">89</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">t_fine </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> (</span><span style="--0:#F5776E;--1:#BF3441">int32_t</span><span style="--0:#ADBAC7;--1:#24292E">)(var1 </span><span style="--0:#F5776E;--1:#BF3441">+</span><span style="--0:#ADBAC7;--1:#24292E"> var2);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">90</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">91</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#ADBAC7;--1:#24292E">temperature </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> ((</span><span style="--0:#F5776E;--1:#BF3441">float</span><span style="--0:#ADBAC7;--1:#24292E">)t_fine) </span><span style="--0:#F5776E;--1:#BF3441">/</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">5129.0</span><span style="--0:#F5776E;--1:#BF3441">f</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">92</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">93</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Status_Ok;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">94</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include &#x22;bme280.h&#x22;#include &#x22;bme280_interface.h&#x22;#define BME280_TX_BUFFER_SIZE 32U#define BME280_RX_BUFFER_SIZE 32U#define BME280_TIMEOUT        200U#define BME280_ADDRESS        0x77U#define BME280_REG_CTRL_MEAS  0xF4U#define BME280_REG_DIG_T      0x88U#define BME280_REG_TEMP       0xFAUstatic uint16_t dig_temp1 = 0U;static int16_t  dig_temp2 = 0;static int16_t  dig_temp3 = 0;BME280_Status_t BME280_init(void){  uint8_t idx                              = 0U;  uint8_t tx_buffer[BME280_TX_BUFFER_SIZE] = {0};  uint8_t rx_buffer[BME280_RX_BUFFER_SIZE] = {0};  BME280_Interface_Status_t status = BME280_Interface_Err;  status = BME280_Interface_init(BME280_ADDRESS,                                 BME280_TIMEOUT);  if (status != BME280_Interface_Ok)      return BME280_Status_Err;  tx_buffer[idx++] = 0b10100011;  status = BME280_Interface_write(      BME280_REG_CTRL_MEAS, tx_buffer, (uint16_t)idx);  if (status != BME280_Interface_Ok)      return BME280_Status_Err;  status = BME280_Interface_read(BME280_REG_DIG_T,                                 rx_buffer, 6U);  if (status != BME280_Interface_Ok)      return BME280_Status_Err;  dig_temp1 = ((uint16_t)rx_buffer[0]);  dig_temp1 =      dig_temp1 | (((uint16_t)rx_buffer[1]) << 8U);  dig_temp2 = ((int16_t)rx_buffer[2]);  dig_temp2 = dig_temp2 | (((int16_t)rx_buffer[3]) << 8U);  dig_temp3 = ((int16_t)rx_buffer[4]);  dig_temp3 = dig_temp3 | (((int16_t)rx_buffer[5]) << 8U);  return BME280_Status_Ok;}BME280_Status_t BME280_get_temperature(float *temperature){  uint8_t rx_buffer[BME280_RX_BUFFER_SIZE] = {0};  int32_t adc_temp                         = 0;  int32_t t_fine                           = 0;  double  var1                             = 0.0;  double  var2                             = 0.0;  BME280_Interface_Status_t status = BME280_Interface_Err;  *temperature = 0.0f;  status = BME280_Interface_read(BME280_REG_TEMP,                                 rx_buffer, 3U);  if (status != BME280_Interface_Ok)      return BME280_Status_Err;  adc_temp =      (int32_t)((((uint32_t)rx_buffer[0]) << 12U) |                (((uint32_t)rx_buffer[1]) << 4U) |                (((uint32_t)rx_buffer[2]) >> 4U));  var1 = (((double)adc_temp) / 16384.0 -          ((double)dig_temp1) / 1024.0) *         ((double)dig_temp2);  var2 = ((((double)adc_temp) / 131072.0 -           ((double)dig_temp1) / 8192.0) *          (((double)adc_temp) / 131072.0 -           ((double)dig_temp1) / 8192.0)) *         ((double)dig_temp3);  t_fine = (int32_t)(var1 + var2);  *temperature = ((float)t_fine) / 5129.0f;  return BME280_Status_Ok;}"><div></div></button></div></figure></div>
<p><em>¬°Et voil√†!</em> Desaparecieron las dependencias del target en la librer√≠a. Tenemos una librer√≠a que funciona para STM32, para MSP430, para PIC32, etc. En los tres archivos de la liber√≠a no deber√≠a aparecer nada propio de ningun target. ¬øQue √©s lo √∫nico que falta? Pues definir las funciones de la interfaz. Esto es lo √∫nico que se debe de migrar/adaptar para cada target.</p>
<div class="chat chat-start"><div class="chat-image avatar"><div class="w-10 rounded-full"><img src="/_astro/albert-pic-profile.CD782flh_2oILFe.webp" alt="Albert" class="m-0" width="40" height="40" loading="lazy" decoding="async"></div></div><div class="chat-bubble">Yo normalmente lo hago dentro de la carpeta <code>Application/bsp/components/</code>.</div></div>
<p>Creamos un archivo llamado <code>bme280_implementation.c</code> con el siguiente contenido:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">bme280_implementation.c</span></figcaption><pre data-language="c"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">"bme280_interface.h"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">#include</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#96D0FF;--1:#032F62">"i2c.h"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">static</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E">  device_address </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span style="--0:#F5776E;--1:#BF3441">static</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E"> device_timeout </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">0</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_init</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">address</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">uint32_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">timeout</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code"><span class="indent">  </span><span style="--0:#DCBDFB;--1:#6F42C1">MX_I2C1_Init</span><span style="--0:#ADBAC7;--1:#24292E">();</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">device_address </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> address;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">device_timeout </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> timeout;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Ok;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_write</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">reg</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#F69D50;--1:#AE4B07">data</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code"><span class="indent">                     </span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">size</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">22</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">HAL_StatusTypeDef status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_ERROR;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">23</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">24</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">25</div></div><div class="code"><span class="indent">      </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Write</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, device_address </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, reg,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">26</div></div><div class="code"><span class="indent">                        </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, data, size, device_timeout);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">27</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">28</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_OK)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">29</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">30</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">31</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Ok;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">32</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">33</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">34</div></div><div class="code"><span style="--0:#6CB6FF;--1:#005CC5">BME280_Interface_Status_t</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">35</div></div><div class="code"><span style="--0:#DCBDFB;--1:#6F42C1">BME280_Interface_read</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">reg</span><span style="--0:#ADBAC7;--1:#24292E">, </span><span style="--0:#F5776E;--1:#BF3441">uint8_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F5776E;--1:#BF3441">*</span><span style="--0:#F69D50;--1:#AE4B07">data</span><span style="--0:#ADBAC7;--1:#24292E">,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">36</div></div><div class="code"><span class="indent">                    </span><span style="--0:#F5776E;--1:#BF3441">uint16_t</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#F69D50;--1:#AE4B07">size</span><span style="--0:#ADBAC7;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">37</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">38</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">HAL_StatusTypeDef status </span><span style="--0:#F5776E;--1:#BF3441">=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_ERROR;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">39</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code"><span class="indent"><span style="--0:#ADBAC7;--1:#24292E">  </span></span><span style="--0:#ADBAC7;--1:#24292E">status </span><span style="--0:#F5776E;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span class="indent">      </span><span style="--0:#DCBDFB;--1:#6F42C1">HAL_I2C_Mem_Read</span><span style="--0:#ADBAC7;--1:#24292E">(</span><span style="--0:#F5776E;--1:#BF3441">&#x26;</span><span style="--0:#ADBAC7;--1:#24292E">hi2c1, device_address </span><span style="--0:#F5776E;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#ADBAC7;--1:#24292E"> </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, reg,</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">42</div></div><div class="code"><span class="indent">                       </span><span style="--0:#6CB6FF;--1:#005CC5">1</span><span style="--0:#F5776E;--1:#BF3441">U</span><span style="--0:#ADBAC7;--1:#24292E">, data, size, device_timeout);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">43</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">44</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">if</span><span style="--0:#ADBAC7;--1:#24292E"> (status </span><span style="--0:#F5776E;--1:#BF3441">!=</span><span style="--0:#ADBAC7;--1:#24292E"> HAL_OK)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">45</div></div><div class="code"><span class="indent">      </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Err;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">46</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">47</div></div><div class="code"><span class="indent">  </span><span style="--0:#F5776E;--1:#BF3441">return</span><span style="--0:#ADBAC7;--1:#24292E"> BME280_Interface_Ok;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">48</div></div><div class="code"><span style="--0:#ADBAC7;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include &#x22;bme280_interface.h&#x22;#include &#x22;i2c.h&#x22;static uint8_t  device_address = 0U;static uint32_t device_timeout = 0U;BME280_Interface_Status_tBME280_Interface_init(uint8_t address, uint32_t timeout){  MX_I2C1_Init();  device_address = address;  device_timeout = timeout;  return BME280_Interface_Ok;}BME280_Interface_Status_tBME280_Interface_write(uint8_t reg, uint8_t *data,                     uint16_t size){  HAL_StatusTypeDef status = HAL_ERROR;  status =      HAL_I2C_Mem_Write(&#x26;hi2c1, device_address << 1U, reg,                        1U, data, size, device_timeout);  if (status != HAL_OK)      return BME280_Interface_Err;  return BME280_Interface_Ok;}BME280_Interface_Status_tBME280_Interface_read(uint8_t reg, uint8_t *data,                    uint16_t size){  HAL_StatusTypeDef status = HAL_ERROR;  status =      HAL_I2C_Mem_Read(&#x26;hi2c1, device_address << 1U, reg,                       1U, data, size, device_timeout);  if (status != HAL_OK)      return BME280_Interface_Err;  return BME280_Interface_Ok;}"><div></div></button></div></figure></div>
<p>De este modo en el caso de querer utilizar la librer√≠a en otro proyecto o en otro target, √∫nicamente deberemos de adaptar el archivo <code>bme280_implementation.c</code>. El resto se mantiene exactamente igual.</p>
</section><section class="heading" data-heading-rank="2"><h2 id="otros-aspectos-a-terner-en-cuenta">Otros aspectos a terner en cuenta</h2>
<p>Con esto hemos visto un ejemplo b√°sico de una liber√≠a. Esta implementaci√≥n es la m√°s sencilla, segura y com√∫n. Sin embargo existen diferentes variantes en funci√≥n de las caracter√≠sticas de nuestro proyecto. En este ejemplo, hemos visto como realizar una selecci√≥n de la implementaci√≥ne en link time. Es decir, tenemos el archivo <code>bme280_implementation.c</code> que provee de las definiciones de las funciones de la interfaz durante el proceso de compilaci√≥n/linkeo. ¬øQu√© ocurrir√≠a si quisieramos tener dos implementaciones? Una para la comunicaci√≥n I2C y otra para la comunicaci√≥n SPI. Pues deber√≠amos de indicar las implementaciones en run time mediante funciones puntero.</p>
<p>Otro aspecto es que en este ejemplo suponemos que solo hay un solo BME280 en el sistema. ¬øQu√© ocurrir√≠a si tubieramos m√°s de uno? ¬øDeber√≠amos de copiar/pegar c√≥digo y a√±adiendole prefijos a las funciones tipo <code>BME280_1</code>y <code>BME280_2</code>? Pues no. No es lo ideal. Lo que har√≠amos ser√≠a hacer uso de <em>handlers</em> que nos permitieran operar con una misma librer√≠a sobre diferentes instancias de un componente.</p>
<p>Estos aspectos y como testear nuestra librer√≠a antes de incluso tener nuestro hardware disponible da para un tema aparte que veremos en otros posts. De momento, ahora ya no tenemos excusa para no implementar las librer√≠as como es debido. Eso s√≠, mi primera recomendaci√≥n (y que parad√≥jicamente he dejado para el final) es que antes que nada te asegures que el fabricante no provea ya una librer√≠a oficial para su componente. Esta es la manera m√°s r√°pida de tener una librer√≠a lista para funcionar. Ten pon seguro que la librer√≠a que provea el fabricante seguri√° una implementacion parecida a la que hemos visto hoy y que nuestra labor ser√° adaptar la parte de implementaci√≥n de la interfaz a nuestro target o producto.</p></section> <div class="w-[20px] h-[5px] bg-base-content mt-16 mb-4"></div><div class="flex gap-x-2 items-center"><div class="font-mono text-sm">Tags:</div><div class="badge badge-outline">firmware</div><div class="badge badge-outline">c</div><div class="badge badge-outline">desarrollo</div></div> </section> <aside class="col-span-1 md:col-span-4 lg:col-span-3" data-astro-cid-g3efgh6g> <section class="hidden md:block" data-astro-cid-g3efgh6g><div class="flex gap-x-2 mb-0 md:mb-16"><div class="badge badge-outline">firmware</div><div class="badge badge-outline">c</div><div class="badge badge-outline">desarrollo</div></div></section> <section class="hidden md:block sticky top-20" data-astro-cid-g3efgh6g> <h2 class="text-lg font-bold">Tabla de contenidos</h2><div class="divider mb-0 mt-0"></div><ul class="toc menu menu-md rounded-box gap-y-2"><li><a href="#aislando-la-librer√≠a-del-target">Aislando la librer√≠a del target</a></li><li><a href="#declaraci√≥n-de-la-api-de-la-librer√≠a">Declaraci√≥n de la API de la librer√≠a</a></li><li><a href="#implementaci√≥n-de-la-api-del-driver">Implementaci√≥n de la API del driver</a></li><li><a href="#declaraci√≥n-de-la-interfaz">Declaraci√≥n de la interfaz</a></li><li><a href="#otros-aspectos-a-terner-en-cuenta">Otros aspectos a terner en cuenta</a></li></ul><script>
  addIntersectionObserver();

  function addIntersectionObserver() {
    const observer = new IntersectionObserver((sections) => {
      sections.forEach((section) => {
        const heading = section.target.querySelector("h2");
        if (!heading) return;
        const id = heading.getAttribute("id");

        // Get the link to this section's heading
        const link = document.querySelector(`.toc li a[href="#${id}"]`);
        if (!link) return;

        // Add/remove the .active class based on whether the
        // section is visible
        const addRemove = section.intersectionRatio > 0 ? "add" : "remove";
        link.classList[addRemove]("active");
      });
    });

    document.querySelectorAll(".article-content section").forEach((section) => {
      observer.observe(section);
    });
  }
</script> </section> </aside> </div> </article>  </main> <footer class="footer bg-base-200 text-base-content p-10 mt-10"> <aside> <div class="flex-1 -ml-4"> <a class="btn btn-ghost text-xl" href="/"><div> <span class="font-thin">the</span><span>Albert</span><span class="font-thin">Dev</span> </div></a> </div> </aside> <nav> <h6 class="footer-title">Explorar</h6> <div class="flex flex-row gap-x-16"> <ul class="menu menu-vertical pl-0"> <li> <a class="-ml-4" href="/">Inicio</a> </li> <li> <a class="-ml-4" href="/posts">Blog</a> </li> <!-- <li>
          <a class="-ml-4" href={translatePath("/publicaciones", lang)}
            >{t("nav.publications")}</a
          >
        </li>
        <li>
          <a class="-ml-4" href={translatePath("/acerca-de", lang)}
            >{t("nav.about")}</a
          >
        </li>
        <li>
          <a class="-ml-4" href={translatePath("/contactar", lang)}
            >{t("nav.contact")}</a
          >
        </li> --> </ul> </div> </nav> <nav> <h6 class="footer-title">Redes sociales</h6> <ul class="menu menu-horizontal pl-0 -ml-4"> <li> <a target="_blank" href="https://linkedin.com/in/thealbertdev"> <svg width="24" height="24" viewBox="0 0 448 512" data-icon="fa6-brands:linkedin-in">  <use xlink:href="#ai:fa6-brands:linkedin-in"></use>  </svg> </a> </li> <li> <a target="_blank" href="https://github.com/TheAlbertDev"> <svg width="24" height="24" viewBox="0 0 496 512" data-icon="fa6-brands:github">  <symbol id="ai:fa6-brands:github"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6c-3.3.3-5.6-1.3-5.6-3.6c0-2 2.3-3.6 5.2-3.6c3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9c2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9c.3 2 2.9 3.3 5.9 2.6c2.9-.7 4.9-2.6 4.6-4.6c-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2c12.8 2.3 17.3-5.6 17.3-12.1c0-6.2-.3-40.4-.3-61.4c0 0-70 15-84.7-29.8c0 0-11.4-29.1-27.8-36.6c0 0-22.9-15.7 1.6-15.4c0 0 24.9 2 38.6 25.8c21.9 38.6 58.6 27.5 72.9 20.9c2.3-16 8.8-27.1 16-33.7c-55.9-6.2-112.3-14.3-112.3-110.5c0-27.5 7.6-41.3 23.6-58.9c-2.6-6.5-11.1-33.3 2.6-67.9c20.9-6.5 69 27 69 27c20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27c13.7 34.7 5.2 61.4 2.6 67.9c16 17.7 25.8 31.5 25.8 58.9c0 96.5-58.9 104.2-114.8 110.5c9.2 7.9 17 22.9 17 46.4c0 33.7-.3 75.4-.3 83.6c0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252C496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2c1.6 1.6 3.9 2.3 5.2 1c1.3-1 1-3.3-.7-5.2c-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9c1.6 1 3.6.7 4.3-.7c.7-1.3-.3-2.9-2.3-3.9c-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2c2.3 2.3 5.2 2.6 6.5 1c1.3-1.3.7-4.3-1.3-6.2c-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2c-1.4-2.3-4-3.3-5.6-2"/></symbol><use xlink:href="#ai:fa6-brands:github"></use>  </svg> </a> </li> <li> <a target="_blank" href="https://x.com/thealbertdev"> <svg width="24" height="24" viewBox="0 0 512 512" data-icon="fa6-brands:x-twitter">  <use xlink:href="#ai:fa6-brands:x-twitter"></use>  </svg> </a> </li> <li> <a target="_blank" href="https://orcid.org/0000-0001-5293-4487"> <svg width="24" height="24" viewBox="0 0 512 512" data-icon="fa6-brands:orcid">  <symbol id="ai:fa6-brands:orcid"><path fill="currentColor" d="M294.75 188.19h-45.92V342h47.47c67.62 0 83.12-51.34 83.12-76.91c0-41.64-26.54-76.9-84.67-76.9M256 8C119 8 8 119 8 256s111 248 248 248s248-111 248-248S393 8 256 8m-80.79 360.76h-29.84v-207.5h29.84zm-14.92-231.14a19.57 19.57 0 1 1 19.57-19.57a19.64 19.64 0 0 1-19.57 19.57M300 369h-81V161.26h80.6c76.73 0 110.44 54.83 110.44 103.85C410 318.39 368.38 369 300 369"/></symbol><use xlink:href="#ai:fa6-brands:orcid"></use>  </svg> </a> </li> </ul> </nav> </footer> </div> <div class="drawer-side" data-astro-cid-6unioc2r> <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay block" data-astro-cid-6unioc2r></label> <div class="relative min-h-full bg-base-200" data-astro-cid-6unioc2r> <ul class="menu w-80 p-4 mt-12 text-lg" data-astro-cid-6unioc2r> <li data-astro-cid-6unioc2r><a href="/" data-astro-cid-6unioc2r>Inicio</a></li> <li data-astro-cid-6unioc2r> <a href="/posts" data-astro-cid-6unioc2r>Blog</a> </li> <!-- <li>
        <a href={translatePath("/acerca-de", lang)}>{t("nav.about")}</a>
      </li>
      <li>
        <a href={translatePath("/contactar", lang)}>{t("nav.contact")}</a>
      </li> --> </ul> <label for="my-drawer" aria-label="close sidebar" class="absolute top-2 right-2 btn btn-square btn-ghost" data-astro-cid-6unioc2r> <svg width="24" height="24" viewBox="0 0 24 24" data-astro-cid-6unioc2r data-icon="mdi:close">  <symbol id="ai:mdi:close"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/></symbol><use xlink:href="#ai:mdi:close"></use>  </svg></label> </div> </div>  </div> </body></html> 